<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ client.client_name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Masonry layout style with smooth transitions for the cards */
    .message-container .message {
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .message-container .message.show {
      opacity: 1;
    }

    .columns {
      column-count: 1;
      column-gap: 1rem;
    }

    @media (min-width: 640px) {
      .columns {
        column-count: 2;
      }
    }

    @media (min-width: 1024px) {
      .columns {
        column-count: 4;
      }
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="container mx-auto">
    <h1 class="text-7xl font-bold mb-6 mt-15">{{ client.client_name }}</h1>

    <!-- Masonry Layout -->
    <div id="message-container" class="columns gap-4 space-y-4">
      <!-- Initial messages loaded from the server -->
    </div>

    <!-- No Messages Fallback -->
    {% if client_msgs|length == 0 %}
      <p class="text-gray-600 text-center mt-10">No messages available for this client.</p>
    {% endif %}
  </div>

  <!-- Polling Script -->
  <script>
    async function fetchMessages() {
             const clientUrl = '{{ client.client_url }}'; // This will be dynamically filled by Django template
             const response = await fetch(`/clients/api/messages/${clientUrl}`);
             const data = await response.json();

if (data.messages) {
        const messageContainer = document.getElementById('message-container');

        // Append only new messages, avoid clearing all the existing content
        data.messages.forEach(msg => {
          // Check if this message is already displayed
          if (!messageContainer.querySelector(`.message[data-id="${msg.id}"]`)) {
            const msgElement = document.createElement('div');
            msgElement.classList.add('message', 'bg-white', 'rounded-lg', 'shadow', 'p-4', 'break-inside-avoid');
            msgElement.setAttribute('data-id', msg.id); // Set a unique ID for the message

            const imgElement = document.createElement('img');
            imgElement.src =  `/clients${msg.image_url}` || 'https://via.placeholder.com/150';
            imgElement.alt = 'Message Image';
            imgElement.classList.add('rounded-lg', 'mb-4');

            const guestName = document.createElement('h2');
            guestName.textContent = `From: ${msg.guest_name}`;
            guestName.classList.add('text-lg', 'font-semibold', 'mb-2');

            const messageContent = document.createElement('p');
            messageContent.textContent = msg.content;
            messageContent.classList.add('text-gray-600', 'mb-4');

            const timestamp = document.createElement('p');
            timestamp.textContent = `Posted on: ${new Date(msg.created_at).toLocaleString()}`;
            timestamp.classList.add('text-sm', 'text-gray-500');

            // Append elements to the message div
            msgElement.appendChild(imgElement);
            msgElement.appendChild(guestName);
            msgElement.appendChild(messageContent);
            msgElement.appendChild(timestamp);

            // Append message to the container with smooth fade-in effect
            messageContainer.appendChild(msgElement);

            // Trigger the fade-in transition by adding the 'show' class
            setTimeout(() => {
              msgElement.classList.add('show');
            }, 50);  // Slight delay for smooth animation
          }
        });
      }
    }

    // Poll every 5 seconds to fetch new messages
    setInterval(fetchMessages, 5000);

    // Initial call to load messages when the page loads
    fetchMessages();
  </script>
</body>
</html>
